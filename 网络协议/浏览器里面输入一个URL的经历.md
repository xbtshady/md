## 浏览器里面输入一个URL的经历

在浏览器里面输入 https://www.kaola.com ，这是一个 **URL**，浏览器只知道名字是“www.kaola.com”，但是不知道具体的地点，所以不知道应该如何访问。于是，它打开地址簿去查找。可以使用一般的地址簿协议 **DNS** 去查找，还可以使用另一种更加精准的地址簿查找协议 **HTTPDNS**。

无论用哪一种方法查找，最终都会得到这个地址：106.114.138.24。这个是 **IP 地址**，是互联网世界的“门牌号”。

知道了目标地址，浏览器就开始打包它的请求。对于普通的浏览请求，往往会使用 **HTTP 协议**；对于需要进行加密传输的请求，往往会使用 **HTTPS 协议**。

**DNS**、**HTTP**、**HTTPS** 所在的层我们称为**应用层**。经过应用层封装后，浏览器会将应用层的包交给下一层去完成，通过 **socket** 编程来实现。

下一层是**传输层**。传输层有两种协议，一种是无连接的协议 **UDP**，一种是面向连接的协议 **TCP**。对于**支付**来讲，往往使用 TCP 协议。所谓的面向连接就是，TCP 会保证这个包能够到达目的地。如果不能到达，就会重新发送，直至到达。

传输层封装完毕后，浏览器会将包交给操作系统的**网络层**。网络层的协议是 **IP 协议**。在 IP 协议里面会有源 IP 地址，即浏览器所在机器的 IP 地址和目标 IP 地址。

操作系统知道了目标 IP 地址之后就会判断是局域网内还是局域网外，如果是局域网外就需要去**网关**，操作系统启动的时候，就会被 DHCP 协议配置 IP 地址，以及默认的网关的 IP 地址 192.168.1.1，操作系统使用IP地址(192.168.1.1)通过**ARP协议**获取该IP主机(网关)的**MAC地址**。

于是操作系统将 IP 包交给了下一层，也就是 **MAC 层**。网卡再将包发出去。由于这个包里面是有 MAC 地址的，因而它能够到达网关。网关收到包之后，会根据自己的知识，判断下一步应该怎么走。网关往往是一个路由器，到某个 IP 地址应该怎么走，这个叫作**路由表**。网关连接着两个局域网，在局域网内使用本地的地址MAC进行通信，跨越局域网通信需要IP地址。网关通过目标IP地址的IP头知道目标IP的网关在那，因为网关之间也会互相通信，沟通不同的IP头应该到那个网关，这种沟通的协议称为**路由协议**，常用的有 **OSPF** 和 **BGP**。

一个网络包往往要经过好几个网关才能到目标网关，中中间的网关虽然不是最终的目标网关，但是他们知道怎么走(下一步先去那个网关)才能将网络包发送到最后的网关，当网络包知道了下一步去哪个网关，还是要使用MAC 地址，通过下一个网关，的 MAC 地址，找到下一个网关。

最后一个网关知道这个网络包就是要去这个局域网的，于是拿着目标IP通过ARP协议大喊一声这是谁？ 目标服务器就会给网关回复一个MAC地址。 然后网络包在最后那个网关修改目标的MAC地址，通过这个MAC地址，网络包找到了目标服务器。

目标服务器发现 MAC 地址对上了，取下 MAC 头来，发送给操作系统的网络层。发现 IP 也对上了，就取下 IP 头。IP 头里会写上一层封装的是 TCP 协议，然后将其交给传输层，即 **TCP 层**。

在这一层里，对于收到的每个包，都会有一个回复的包说明收到了。这个回复的包绝非这次请求的结果，例如购物是否成功，扣了多少钱等，而仅仅是 TCP 层的一个说明，即收到之后的回复。当然这个回复，会沿着刚才来的方向走回去，报个平安。

如果过一段时间还是没到，发送端的 TCP 层会重新发送这个包，还是上面的过程，直到有一天收到平安到达的回复。这个重试绝非你的浏览器重新将下单这个动作重新请求一次。对于浏览器来讲，就发送了一次下单请求，TCP 层不断自己闷头重试。除非 TCP 这一层出了问题，例如连接断了，才轮到浏览器的应用层重新发送下单请求。

当网络包平安到达 TCP 层之后，TCP 头中有目标端口号，通过这个**端口号**，可以找到服务器的进程正在监听这个端口号，假设是一个 Tomcat，将这个包发给网站。

![a35e16acd0912ae3e79567ca0358df9e](..\img\网络协议\1-1.jpg)